# check if user in fsub or not
from database.users_chats_db import db
from pyrogram.errors import UserNotParticipant
import asyncio
from pyrogram.types import InlineKeyboardMarkup, InlineKeyboardButton
import traceback


@Client.on_message(filters.group & filters.text & filters.incoming)
async def give_filter(client, message):
    if message.chat.id != SUPPORT_CHAT_ID:
        settings = await get_settings(message.chat.id)
        chatid = message.chat.id 
        user_id = message.from_user.id if message.from_user else 0
        if settings['fsub'] != None:
            try:
                btn = await pub_is_subscribed(client, message, settings['fsub'])
                if btn:
                    btn.append([InlineKeyboardButton("Joined ‚úÖ", callback_data=f"unmuteme#{int(user_id)}")])
                    await client.restrict_chat_member(chatid, message.from_user.id, ChatPermissions(can_send_messages=False))
                    await message.reply_photo(photo=random.choice(PICS), caption=f"üëã Hello {message.from_user.mention},\n\nPlease join the channel then click on Joined button. üòá", reply_markup=InlineKeyboardMarkup(btn), parse_mode=enums.ParseMode.HTML)
                    return
            except Exception as e:
                print(e)
            
        manual = await manual_filters(client, message)
        if manual == False:
            settings = await get_settings(message.chat.id)
            try:
                if settings['auto_ffilter']:
                    ai_search = True
                    reply_msg = await message.reply_text(f"<b><i>Searching For {message.text} üîç</i></b>")
                    await auto_filter(client, message.text, message, reply_msg, ai_search)
            except KeyError:
                grpid = await active_connection(str(message.from_user.id))
                await save_group_settings(grpid, 'auto_ffilter', True)
                settings = await get_settings(message.chat.id)
                if settings['auto_ffilter']:
                    ai_search = True
                    reply_msg = await message.reply_text(f"<b><i>Searching For {message.text} üîç</i></b>")
                    await auto_filter(client, message.text, message, reply_msg, ai_search)
    else: #a better logic to avoid repeated lines of code in auto_filter function
        search = message.text
        temp_files, temp_offset, total_results = await get_search_results(chat_id=message.chat.id, query=search.lower(), offset=0, filter=True)
        if total_results == 0:
            return
        else:
            return await message.reply_text(f"<b>H·¥á è {message.from_user.mention}, {str(total_results)}  Ä·¥ás·¥ú ü·¥õs ·¥Ä Ä·¥á “ì·¥è·¥ú…¥·¥Ö …™…¥ ·¥ç è ·¥Ö·¥Ä·¥õ·¥Ä ô·¥Äs·¥á “ì·¥è Ä  è·¥è·¥ú Ä ·¥èÃ®·¥ú·¥á Ä è {search}. \n\nT ú…™s …™s ·¥Ä s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò s·¥è ·¥õ ú·¥Ä·¥õ  è·¥è·¥ú ·¥Ñ·¥Ä…¥'·¥õ …¢·¥á·¥õ “ì…™ ü·¥ás “ì Ä·¥è·¥ç  ú·¥á Ä·¥á...\n\nJ·¥è…™…¥ ·¥Ä…¥·¥Ö S·¥á·¥Ä Ä·¥Ñ ú H·¥á Ä·¥á - https://t.me/+TkKVc95vuKJlY2E1</b>")
		    
